<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üí¨ Full Chat</title>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#e5ddd5;display:flex;height:100vh;overflow:hidden;}
#home {width:100%;display:flex;flex-direction:column;}
#sidebar {width:100%;max-width:400px;margin:auto;background:#075E54;color:#fff;display:flex;flex-direction:column;height:100%;}
#sidebar h2 {text-align:center;padding:12px 0;border-bottom:1px solid #128C7E;}
#user-list {flex:1;overflow-y:auto;padding:10px;}
.user-btn {display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,.1);cursor:pointer;transition:0.2s;}
.user-btn:hover {background:rgba(255,255,255,.2);}
.user-btn img {width:32px;height:32px;border-radius:50%;}
#chat-view {display:none;flex-direction:column;height:100%;width:100%;max-width:400px;margin:auto;background:#f0f0f0;border-radius:12px;}
.chat-header {background:#25D366;color:#fff;padding:10px;font-weight:700;display:flex;justify-content:space-between;align-items:center;border-radius:12px 12px 0 0;}
.chat-body {flex:1;padding:10px;overflow-y:auto;background:#e5ddd5;}
.msg {padding:6px 10px;border-radius:7px;margin:5px;max-width:70%;word-wrap:break-word;}
.my-msg {background:#dcf8c6;margin-left:auto;}
.other-msg {background:white;margin-right:auto;}
.chat-input {display:flex;padding:8px;gap:5px;border-top:1px solid #ccc;align-items:center;}
.chat-input input {flex:1;padding:8px 10px;border-radius:20px;border:none;outline:none;}
.send-btn, #voice-btn {background:#25D366;border:none;color:#fff;padding:8px 12px;border-radius:50%;cursor:pointer;font-size:16px;}
#emoji-btn {background:transparent;border:none;font-size:20px;cursor:pointer;margin-right:5px;}
#emoji-panel {position:absolute;bottom:60px;left:10px;background:white;border:1px solid #ccc;padding:5px;border-radius:10px;display:none;flex-wrap:wrap;width:200px;max-height:150px;overflow-y:auto;}
#emoji-panel span {font-size:20px;cursor:pointer;margin:3px;}
.back-btn {cursor:pointer;font-weight:bold;}
#audio-call {margin-left:5px;background:#128C7E;padding:8px 12px;border-radius:50%;color:#fff;cursor:pointer;}
</style>
</head>
<body>

<div id="home">
  <div id="sidebar">
    <h2>‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</h2>
    <div id="user-list"></div>
  </div>
</div>

<div id="chat-view">
  <div class="chat-header">
    <span id="chat-with">User</span>
    <span class="back-btn" id="back-btn">‚è™ ‡¶π‡ßã‡¶Æ</span>
  </div>
  <div class="chat-body" id="chat-body"></div>
  <div class="chat-input">
    <button id="emoji-btn">üòä</button>
    <input type="text" id="chat-input" placeholder="Type a message...">
    <button class="send-btn" id="chat-send">‚û§</button>
    <button id="voice-btn">üé§</button>
    <button id="audio-call">üìû</button>
    <div id="emoji-panel"></div>
  </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBBlwLt-VjIyWsev93QJoC6QG5fx9PpTzQ",
    authDomain: "sahaporan-20c38.firebaseapp.com",
    databaseURL: "https://sahaporan-20c38-default-rtdb.firebaseio.com",
    projectId: "sahaporan-20c38",
    storageBucket: "sahaporan-20c38.appspot.com",
    messagingSenderId: "52257841743",
    appId: "1:52257841743:web:48cef728f0d0738d88403a",
    measurementId: "G-2FGKNQ2168"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// User
let username = localStorage.getItem("chat_username");
let avatar = localStorage.getItem("chat_avatar");
if (!username) { username = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:"); avatar = `https://i.pravatar.cc/150?u=${username}`; localStorage.setItem("chat_username", username); localStorage.setItem("chat_avatar", avatar); }

// Online presence
const userStatusRef = db.ref("onlineUsers/"+username);
userStatusRef.set({name:username,avatar});
userStatusRef.onDisconnect().remove();

// Elements
const userListEl = document.getElementById("user-list");
const homeEl = document.getElementById("home");
const chatView = document.getElementById("chat-view");
const chatWithEl = document.getElementById("chat-with");
const chatBodyEl = document.getElementById("chat-body");
const chatInput = document.getElementById("chat-input");
const chatSendBtn = document.getElementById("chat-send");
const backBtn = document.getElementById("back-btn");
const emojiBtn = document.getElementById("emoji-btn");
const emojiPanel = document.getElementById("emoji-panel");
const voiceBtn = document.getElementById("voice-btn");
const audioCallBtn = document.getElementById("audio-call");

let currentChatUser = "";

// Emoji
const emojis = ["üòÄ","üòÇ","ü§£","üòä","üòç","üòò","üòú","üòé","ü§©","üòá","üò¢","üò≠","üò°","üëç","üëé","üôè","üí™","üëè","üôå","üî•","‚ù§Ô∏è","üíî","‚≠ê","‚ú®","üéâ"];
emojis.forEach(e=>{ let span = document.createElement("span"); span.textContent=e; span.onclick=()=>{chatInput.value+=e; emojiPanel.style.display="none";}; emojiPanel.appendChild(span); });
emojiBtn.onclick=()=>{ emojiPanel.style.display = emojiPanel.style.display==="flex"?"none":"flex"; };

// Load users
db.ref("onlineUsers").on("value", snap=>{
    userListEl.innerHTML="";
    snap.forEach(child=>{
        const user = child.val();
        if(user.name===username) return;
        const btn=document.createElement("div");
        btn.className="user-btn";
        btn.innerHTML=`<img src="${user.avatar}"><span>${user.name}</span>`;
        btn.onclick = ()=>openChat(user.name);
        userListEl.appendChild(btn);
    });
});

// Open chat
function openChat(otherName){
    currentChatUser = otherName;
    homeEl.style.display="none";
    chatView.style.display="flex";
    chatWithEl.textContent = otherName;
    chatBodyEl.innerHTML="";
    loadMessages();
}

// Back to home
backBtn.onclick = ()=>{ chatView.style.display="none"; homeEl.style.display="flex"; currentChatUser=""; }

// Send message
chatSendBtn.onclick = sendMessage;
chatInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

function sendMessage(){
    const text = chatInput.value.trim();
    if(!text || !currentChatUser) return;
    const msgData = {from:username,to:currentChatUser,text,time:new Date().toLocaleTimeString()};
    db.ref("privateMessages").push(msgData);
    chatInput.value="";
}

// Load messages
function loadMessages(){
    db.ref("privateMessages").on("value", snap=>{
        chatBodyEl.innerHTML="";
        snap.forEach(child=>{
            const m = child.val();
            if((m.from===username && m.to===currentChatUser)||(m.from===currentChatUser && m.to===username)){
                const div = document.createElement("div");
                div.className = "msg " + (m.from===username ? "my-msg":"other-msg");
                div.innerHTML = `${m.text}<br><small>${m.time}</small>`;
                chatBodyEl.appendChild(div);
            }
        });
        chatBodyEl.scrollTop = chatBodyEl.scrollHeight;
    });
}

// Voice message
let mediaRecorder;
let audioChunks = [];
voiceBtn.onclick=async()=>{
    if(!mediaRecorder || mediaRecorder.state==="inactive"){
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
        mediaRecorder.onstop = async ()=>{
            const blob = new Blob(audioChunks,{type:"audio/webm"});
            const ref = storage.ref(`voice_${Date.now()}.webm`);
            await ref.put(blob);
            const url = await ref.getDownloadURL();
            const msgData = {from:username,to:currentChatUser,text:`<audio controls src="${url}"></audio>`,time:new Date().toLocaleTimeString()};
            db.ref("privateMessages").push(msgData);
            audioChunks=[];
        };
        mediaRecorder.start();
        voiceBtn.textContent="‚èπÔ∏è Stop";
    } else if(mediaRecorder.state==="recording"){
        mediaRecorder.stop();
        voiceBtn.textContent="üé§";
    }
};

// Simple WebRTC audio call (peer-to-peer)
let localStream;
let peerConnection;
const config = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
audioCallBtn.onclick=async()=>{
    if(peerConnection){ peerConnection.close(); peerConnection=null; return; }
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));
    peerConnection.ontrack = e=>{ const audio = document.createElement("audio"); audio.srcObject=e.streams[0]; audio.autoplay=true; document.body.appendChild(audio); };
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    // Note: signaling server needed to exchange offer/answer with remote peer
    alert("WebRTC setup ready. For full audio call, a signaling server is required.");
};
</script>
</body>
</html>